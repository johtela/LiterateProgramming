

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>MSBuildHelpers - Literate Programming</title>

	<link rel="icon" type="image/x-icon" href="../images/favicon.ico">
    <link rel="stylesheet" href="../bootstrap/css/readable/bootstrap.min.css" />
<link rel="stylesheet" href="../font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="../sidebar/sidebar.min.css" />
<link rel="stylesheet" href="../css/book.min.css" />
<link rel="stylesheet" href="../syntax-highlight/solarized-light.min.css" />
<link rel="stylesheet" href="../mermaid/mermaid.css" />

</head>

<body>
    
    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="../index.html">Literate Programming</a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li><a href="../index.html"><i class="fa fa-home" aria-hidden="true"></i> Home</a></li>
					<li><a href="https://github.com/johtela/LiterateProgramming"><i class="fa fa-github" aria-hidden="true"></i> GitHub Repository</a></li>
                    <li><a href="https://github.com/johtela/LiterateProgramming/releases"><i class="fa fa-download" aria-hidden="true"></i> Download</a></li>
                    <li><a href="../License.html">License</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-md-3 hidden-xs hidden-sm">
                
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4>On This Page</h4>
            </div>
            <div id="header-menu" class="panel-body main-menu">
                <ul></ul>
            </div>
        </div>  
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4>Table of Contents</h4>
            </div>
            <div class="panel-body main-menu">
                <ul>
	<li><a href="../index.html">Home</a></li>
	<ul>
	</ul>
	<li><a href="../Introduction.html">Introduction</a></li>
	<ul>
	</ul>
	<li><a href="../src/Options.html">Command Line Options</a></li>
	<ul>
	</ul>
	<li><a href="../src/Program.html">Main Program</a></li>
	<ul>
	</ul>
	<li><a href="../src/SplitPath.html">SplitPath Structure</a></li>
	<ul>
	</ul>
	<li><a href="../src/Weaver.html">Document Weaver</a></li>
	<ul>
	</ul>
	<li><a href="../src/MdWeaver.html">Markdown Weaver</a></li>
	<ul>
	</ul>
	<li><a href="../src/HtmlWeaver.html">HTML Weaver</a></li>
	<ul>
	</ul>
	<li><a href="../src/TocManager.html">TOC Manager</a></li>
	<ul>
	</ul>
	<li><a href="../src/MSBuildHelpers.html" class="selected">MSBuild Helpers</a></li>
	<ul>
	</ul>
	<li><a href="../src/BlockList.html">Source Blocks</a></li>
	<ul>
	</ul>
	<li><a href="../src/Macro.html">Macros</a></li>
	<ul>
	</ul>
	<li><a href="../src/BlockBuilder.html">Block Builder</a></li>
	<ul>
	</ul>
	<li><a href="../src/HtmlBlockBuilder.html">HTML Block Builder</a></li>
	<ul>
	</ul>
	<li><a href="../src/HtmlGenerator.html">HTML Generation</a></li>
	<ul>
	</ul>
	<li>Themes</li>
	<ul>
<ul>
	<li><a href="../CSWeave.Theme/DirHelpers.html">Directory Utilities</a></li>
	<ul>
	</ul>
	<li><a href="../CSWeave.Theme/Toc.html">Table of Contents Classes</a></li>
	<ul>
	</ul>
	<li><a href="../CSWeave.Theme/PageParams.html">Page Parameters</a></li>
	<ul>
	</ul>
	<li><a href="../CSWeave.Theme/Theme.html">Theme Base Class</a></li>
	<ul>
	</ul>
</ul>
	</ul>
	<li><a href="../FrontMatter.html">Front Matter</a></li>
	<ul>
	</ul>
	<li><a href="../TableOfContents.html">Table of Contents File</a></li>
	<ul>
	</ul>
	<li><a href="../TipsAndTricks.html">Tips &amp; Tricks</a></li>
	<ul>
	</ul>
	<li><a href="../License.html">License</a></li>
	<ul>
	</ul>
	<li><a href="../README.html">README</a></li>
	<ul>
	</ul>
</ul>
            </div>
        </div>

            </div>
			<div class="col-md-9">
				<ul class="pager">
	<li class="previous"><a href="../src/TocManager.html">Previous: TOC Manager</a></li>
	<li class="next"><a href="../src/BlockList.html">Next: Source Blocks</a></li>
</ul>
				<div id="static-content" class="markdown">
					<h1 id="working-with-msbuild-files">Working with MSBuild Files</h1>
<p>Loading and compiling a solution with Roslyn involves quite a lot of steps
making the task somewhat complicated. Therefore, we encapsulate the complex
stuff to a static helper class that hides the intermediate steps.</p>
<p><strong>Side note:</strong> I am not entirely sure that the way we are managing project
references is the preferred approach. The documentation of Roslyn and especially
<a href="http://www.coderesx.com/roslyn/html/334B7980.htm">MSBuildWorkspace</a> is really
lacking on this topic. Anyhow, the current implementation is the only way I
could get the assembly references at least mostly working. The compiler still
complains about missing references, but the semantic information seems to be
available nevertheless.</p>
<pre class="csharp"><code class="csharp"><span class="keyword" id="LiterateProgramming">namespace</span> LiterateProgramming
<span class="punctuation">{</span>
	<span class="keyword">using</span> System<span class="punctuation">;</span>
	<span class="keyword">using</span> System<span class="punctuation">.</span>Collections<span class="punctuation">.</span>Generic<span class="punctuation">;</span>
	<span class="keyword">using</span> System<span class="punctuation">.</span>Linq<span class="punctuation">;</span>
	<span class="keyword">using</span> System<span class="punctuation">.</span>IO<span class="punctuation">;</span>
	<span class="keyword">using</span> Microsoft<span class="punctuation">.</span>CodeAnalysis<span class="punctuation">;</span>
	<span class="keyword">using</span> Microsoft<span class="punctuation">.</span>Build<span class="punctuation">.</span>Construction<span class="punctuation">;</span>
	<span class="keyword">using</span> CSWeave<span class="punctuation">.</span>Theme<span class="punctuation">;</span>

	<span class="keyword" id="LiterateProgramming.MSBuildHelpers">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="typename">MSBuildHelpers</span>
	<span class="punctuation">{</span>
</code></pre>
<h2 id="opening-a-solution">Opening a Solution</h2>
<p>Parsing the solution file reads it into memory allowing us to access
the information contained in it.</p>
<pre class="csharp"><code class="csharp">		<span class="keyword" id="LiterateProgramming.MSBuildHelpers.OpenSolution(string)" data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.OpenSolution(string)">public</span> <span class="keyword" data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.OpenSolution(string)">static</span> <span class="typename" data-toggle="tooltip" title="Microsoft.Build.Construction.SolutionFile">SolutionFile</span> <span data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.OpenSolution(string)">OpenSolution</span> <span class="punctuation">(</span><span class="keyword" data-toggle="tooltip" title="string">string</span> filename<span class="punctuation">)</span>
		<span class="punctuation">{</span>
			<span class="keyword">return</span> <span class="typename" data-toggle="tooltip" title="Microsoft.Build.Construction.SolutionFile">SolutionFile</span><span class="punctuation" data-toggle="tooltip" title="Microsoft.Build.Construction.SolutionFile.Parse(string)">.</span><span data-toggle="tooltip" title="Microsoft.Build.Construction.SolutionFile.Parse(string)">Parse</span> <span class="punctuation">(</span><span class="typename" data-toggle="tooltip" title="System.IO.Path">Path</span><span class="punctuation" data-toggle="tooltip" title="System.IO.Path.GetFullPath(string)">.</span><span data-toggle="tooltip" title="System.IO.Path.GetFullPath(string)">GetFullPath</span> <span class="punctuation">(</span><span data-toggle="tooltip" title="string">filename</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
		<span class="punctuation">}</span>
</code></pre>
<h2 id="loading-and-compiling-projects">Loading and Compiling Projects</h2>
<p>Once we have opened a solution we can load and compile the projects
inside it. For that we need both the <code>Solution</code> object defined by
Roslyn as well as the <code>SolutionFile</code> object defined in
<code>Microsoft.Build.Construction</code>.</p>
<pre class="csharp"><code class="csharp">		<span class="keyword" id="LiterateProgramming.MSBuildHelpers.LoadProjectsInSolution(Microsoft.CodeAnalysis.Solution, Microsoft.Build.Construction.SolutionFile)" data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.LoadProjectsInSolution(Microsoft.CodeAnalysis.Solution, Microsoft.Build.Construction.SolutionFile)">public</span> <span class="keyword" data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.LoadProjectsInSolution(Microsoft.CodeAnalysis.Solution, Microsoft.Build.Construction.SolutionFile)">static</span> <span class="typename" data-toggle="tooltip" title="System.Collections.Generic.IEnumerable<Microsoft.CodeAnalysis.Project>">IEnumerable</span><span class="punctuation">&lt;</span><span class="typename" data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">Project</span><span class="punctuation">&gt;</span> <span data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.LoadProjectsInSolution(Microsoft.CodeAnalysis.Solution, Microsoft.Build.Construction.SolutionFile)">LoadProjectsInSolution</span> <span class="punctuation">(</span><span class="typename" data-toggle="tooltip" title="Microsoft.CodeAnalysis.Solution">Solution</span> solution<span class="punctuation">,</span> 
			<span class="typename" data-toggle="tooltip" title="Microsoft.Build.Construction.SolutionFile">SolutionFile</span> solutionFile<span class="punctuation">)</span>
		<span class="punctuation">{</span>
</code></pre>
<p>First we enumerate the projects in solution using Roslyn.</p>
<pre class="csharp"><code class="csharp">			<span class="keyword">foreach</span> <span class="punctuation">(</span><span class="keyword" data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">var</span> proj <span class="keyword">in</span> <span data-toggle="tooltip" title="Microsoft.CodeAnalysis.Solution">solution</span><span class="punctuation" data-toggle="tooltip" title="System.Collections.Generic.IEnumerable<Microsoft.CodeAnalysis.Project>">.</span><span data-toggle="tooltip" title="System.Collections.Generic.IEnumerable<Microsoft.CodeAnalysis.Project>">Projects</span><span class="punctuation">)</span>
			<span class="punctuation">{</span>
</code></pre>
<p>For the current project we will find the corresponding entry
in the <code>SolutionFile</code>. This is done by a helper function defined
below.</p>
<pre class="csharp"><code class="csharp">				<span class="keyword" data-toggle="tooltip" title="Microsoft.Build.Construction.ProjectInSolution">var</span> <span id="projFile">projFile</span> <span class="punctuation">=</span> <span data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.FindProjectInSolution(Microsoft.CodeAnalysis.Project, Microsoft.Build.Construction.SolutionFile)"><a href="../src/MSBuildHelpers.html#LiterateProgramming.MSBuildHelpers.FindProjectInSolution(Microsoft.CodeAnalysis.Project, Microsoft.Build.Construction.SolutionFile)">FindProjectInSolution</a></span> <span class="punctuation">(</span><span data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">proj</span><span class="punctuation">,</span> <span data-toggle="tooltip" title="Microsoft.Build.Construction.SolutionFile">solutionFile</span><span class="punctuation">)</span><span class="punctuation">;</span>
</code></pre>
<p>The project root directory is the folder where the project file
resides.</p>
<pre class="csharp"><code class="csharp">				<span class="keyword" data-toggle="tooltip" title="Microsoft.Build.Construction.ProjectRootElement">var</span> <span id="projRoot">projRoot</span> <span class="punctuation">=</span> <span class="typename" data-toggle="tooltip" title="Microsoft.Build.Construction.ProjectRootElement">ProjectRootElement</span><span class="punctuation" data-toggle="tooltip" title="Microsoft.Build.Construction.ProjectRootElement.Open(string)">.</span><span data-toggle="tooltip" title="Microsoft.Build.Construction.ProjectRootElement.Open(string)">Open</span> <span class="punctuation">(</span><span data-toggle="tooltip" title="Microsoft.Build.Construction.ProjectInSolution">projFile</span><span class="punctuation" data-toggle="tooltip" title="string">.</span><span data-toggle="tooltip" title="string">AbsolutePath</span><span class="punctuation">)</span><span class="punctuation">;</span>
</code></pre>
<p>Next we need to get the .NET framework version the project is
compiled against. This is needed to locate the folder where the
reference assemblies are. They contain facades for .NET framework
classes that are loaded automatically. Roslyn needs the facades
to access the metadata associated to the classes.</p>
<pre class="csharp"><code class="csharp">				<span class="keyword" data-toggle="tooltip" title="string">var</span> <span id="frameworkVersion">frameworkVersion</span> <span class="punctuation">=</span> <span data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.ProjectProperty(Microsoft.Build.Construction.ProjectRootElement, string)"><a href="../src/MSBuildHelpers.html#LiterateProgramming.MSBuildHelpers.ProjectProperty(Microsoft.Build.Construction.ProjectRootElement, string)">ProjectProperty</a></span> <span class="punctuation">(</span><span data-toggle="tooltip" title="Microsoft.Build.Construction.ProjectRootElement">projRoot</span><span class="punctuation">,</span> <span class="string" data-toggle="tooltip" title="string">&quot;TargetFrameworkVersion&quot;</span><span class="punctuation">)</span><span class="punctuation">;</span>
				<span class="keyword" data-toggle="tooltip" title="string">var</span> <span id="refAssyDir">refAssyDir</span> <span class="punctuation">=</span> <span class="typename" data-toggle="tooltip" title="System.IO.Path">Path</span><span class="punctuation" data-toggle="tooltip" title="System.IO.Path.Combine(string, string, string)">.</span><span data-toggle="tooltip" title="System.IO.Path.Combine(string, string, string)">Combine</span> <span class="punctuation">(</span>
					<span class="typename" data-toggle="tooltip" title="System.Environment">Environment</span><span class="punctuation" data-toggle="tooltip" title="System.Environment.GetFolderPath(System.Environment.SpecialFolder)">.</span><span data-toggle="tooltip" title="System.Environment.GetFolderPath(System.Environment.SpecialFolder)">GetFolderPath</span> <span class="punctuation">(</span><span class="typename" data-toggle="tooltip" title="System.Environment">Environment</span><span class="punctuation" data-toggle="tooltip" title="System.Environment.SpecialFolder">.</span><span class="typename" data-toggle="tooltip" title="System.Environment.SpecialFolder">SpecialFolder</span><span class="punctuation" data-toggle="tooltip" title="System.Environment.SpecialFolder">.</span><span data-toggle="tooltip" title="System.Environment.SpecialFolder">ProgramFilesX86</span><span class="punctuation">)</span><span class="punctuation">,</span>
					<span class="string" data-toggle="tooltip" title="string">@&quot;Reference Assemblies\Microsoft\Framework\.NETFramework\&quot;</span><span class="punctuation">,</span>
					<span data-toggle="tooltip" title="string">frameworkVersion</span><span class="punctuation">)</span><span class="punctuation">;</span>
</code></pre>
<p>Solution directory is the current directory when a project is
compiled. If there are assembly references with relative file
paths, we need to concatenate them to the solution directory to
get their absolute paths.</p>
<pre class="csharp"><code class="csharp">				<span class="keyword" data-toggle="tooltip" title="string">var</span> <span id="solutionDir">solutionDir</span> <span class="punctuation">=</span> <span class="typename" data-toggle="tooltip" title="System.IO.Path">Path</span><span class="punctuation" data-toggle="tooltip" title="System.IO.Path.GetDirectoryName(string)">.</span><span data-toggle="tooltip" title="System.IO.Path.GetDirectoryName(string)">GetDirectoryName</span> <span class="punctuation">(</span><span data-toggle="tooltip" title="Microsoft.CodeAnalysis.Solution">solution</span><span class="punctuation" data-toggle="tooltip" title="string">.</span><span data-toggle="tooltip" title="string">FilePath</span><span class="punctuation">)</span><span class="punctuation">;</span>
</code></pre>
<p>Now we can add references to the facade assemblies.</p>
<pre class="csharp"><code class="csharp">				<span class="keyword" data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">var</span> <span id="p">p</span> <span class="punctuation">=</span> <span data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.AddFacadeReferences(Microsoft.CodeAnalysis.Project, string)"><a href="../src/MSBuildHelpers.html#LiterateProgramming.MSBuildHelpers.AddFacadeReferences(Microsoft.CodeAnalysis.Project, string)">AddFacadeReferences</a></span> <span class="punctuation">(</span><span data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">proj</span><span class="punctuation">,</span> <span data-toggle="tooltip" title="string">refAssyDir</span><span class="punctuation">)</span><span class="punctuation">;</span>
</code></pre>
<p>And then we can add the &quot;normal&quot; references.</p>
<pre class="csharp"><code class="csharp">				<span data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">p</span> <span class="punctuation" data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">=</span> <span data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.AddReferences(Microsoft.CodeAnalysis.Project, Microsoft.Build.Construction.ProjectRootElement, string)"><a href="../src/MSBuildHelpers.html#LiterateProgramming.MSBuildHelpers.AddReferences(Microsoft.CodeAnalysis.Project, Microsoft.Build.Construction.ProjectRootElement, string)">AddReferences</a></span> <span class="punctuation">(</span><span data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">p</span><span class="punctuation">,</span> <span data-toggle="tooltip" title="Microsoft.Build.Construction.ProjectRootElement">projRoot</span><span class="punctuation">,</span> <span data-toggle="tooltip" title="string">refAssyDir</span><span class="punctuation">)</span><span class="punctuation">;</span>
</code></pre>
<p>Finally we can compile the project and yield it out for enumeration.
If there are compilation errors, they will be outputted to the console
window. As noted above, getting referencing errors does not necessarily
mean that the required semantic information is not available in compiled
project.</p>
<pre class="csharp"><code class="csharp">				<span class="keyword" data-toggle="tooltip" title="System.Collections.Immutable.ImmutableArray<Microsoft.CodeAnalysis.Diagnostic>">var</span> <span id="diag">diag</span> <span class="punctuation">=</span> <span data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">p</span><span class="punctuation" data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project.GetCompilationAsync(System.Threading.CancellationToken)">.</span><span data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project.GetCompilationAsync(System.Threading.CancellationToken)">GetCompilationAsync</span> <span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation" data-toggle="tooltip" title="Microsoft.CodeAnalysis.Compilation">.</span><span data-toggle="tooltip" title="Microsoft.CodeAnalysis.Compilation">Result</span><span class="punctuation" data-toggle="tooltip" title="Microsoft.CodeAnalysis.Compilation.GetDiagnostics(System.Threading.CancellationToken)">.</span><span data-toggle="tooltip" title="Microsoft.CodeAnalysis.Compilation.GetDiagnostics(System.Threading.CancellationToken)">GetDiagnostics</span> <span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span>
				<span class="keyword">foreach</span> <span class="punctuation">(</span><span class="keyword" data-toggle="tooltip" title="var">var</span> msg <span class="keyword">in</span> <span data-toggle="tooltip" title="System.Collections.Immutable.ImmutableArray<Microsoft.CodeAnalysis.Diagnostic>">diag</span><span class="punctuation">)</span>
					<span class="typename" data-toggle="tooltip" title="System.Console">Console</span><span class="punctuation" data-toggle="tooltip" title="System.IO.TextWriter">.</span><span data-toggle="tooltip" title="System.IO.TextWriter">Error</span><span class="punctuation" data-toggle="tooltip" title="System.IO.TextWriter.WriteLine()">.</span><span data-toggle="tooltip" title="System.IO.TextWriter.WriteLine()">WriteLine</span> <span class="punctuation">(</span><span data-toggle="tooltip" title="var">msg</span><span class="punctuation">)</span><span class="punctuation">;</span>
				<span class="keyword">yield</span> <span class="keyword">return</span> <span data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">p</span><span class="punctuation">;</span>
			<span class="punctuation">}</span>
		<span class="punctuation">}</span>
</code></pre>
<h2 id="adding-references">Adding References</h2>
<p>References that are not loaded automatically by the .NET framework are listed
in a project file. We need to find items in the file with type &quot;Reference&quot; and
determine where the corresponding assemblies are located on disk.</p>
<pre class="csharp"><code class="csharp">		<span class="keyword" id="LiterateProgramming.MSBuildHelpers.AddReferences(Microsoft.CodeAnalysis.Project, Microsoft.Build.Construction.ProjectRootElement, string)" data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.AddReferences(Microsoft.CodeAnalysis.Project, Microsoft.Build.Construction.ProjectRootElement, string)">private</span> <span class="keyword" data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.AddReferences(Microsoft.CodeAnalysis.Project, Microsoft.Build.Construction.ProjectRootElement, string)">static</span> <span class="typename" data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">Project</span> <span data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.AddReferences(Microsoft.CodeAnalysis.Project, Microsoft.Build.Construction.ProjectRootElement, string)">AddReferences</span> <span class="punctuation">(</span><span class="typename" data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">Project</span> proj<span class="punctuation">,</span> <span class="typename" data-toggle="tooltip" title="Microsoft.Build.Construction.ProjectRootElement">ProjectRootElement</span> projRoot<span class="punctuation">,</span> 
			<span class="keyword" data-toggle="tooltip" title="string">string</span> refAssyDir<span class="punctuation">)</span>
		<span class="punctuation">{</span>
			<span class="keyword" data-toggle="tooltip" title="?">var</span> <span id="references">references</span> <span class="punctuation">=</span> <span data-toggle="tooltip" title="Microsoft.Build.Construction.ProjectRootElement">projRoot</span><span class="punctuation" data-toggle="tooltip" title="System.Collections.Generic.ICollection<Microsoft.Build.Construction.ProjectItemElement>">.</span><span data-toggle="tooltip" title="System.Collections.Generic.ICollection<Microsoft.Build.Construction.ProjectItemElement>">Items</span><span class="punctuation" data-toggle="tooltip" title="System.Collections.Generic.IEnumerable<Microsoft.Build.Construction.ProjectItemElement>.Where<Microsoft.Build.Construction.ProjectItemElement>(System.Func<Microsoft.Build.Construction.ProjectItemElement, bool>)">.</span><span data-toggle="tooltip" title="System.Collections.Generic.IEnumerable<Microsoft.Build.Construction.ProjectItemElement>.Where<Microsoft.Build.Construction.ProjectItemElement>(System.Func<Microsoft.Build.Construction.ProjectItemElement, bool>)">Where</span> <span class="punctuation">(</span>i <span class="punctuation" data-toggle="tooltip" title="lambda expression">=&gt;</span> <span data-toggle="tooltip" title="Microsoft.Build.Construction.ProjectItemElement">i</span><span class="punctuation" data-toggle="tooltip" title="string">.</span><span data-toggle="tooltip" title="string">ItemType</span> <span class="punctuation" data-toggle="tooltip" title="bool">==</span> <span class="string" data-toggle="tooltip" title="string">&quot;Reference&quot;</span><span class="punctuation">)</span><span class="punctuation">;</span>
			<span class="keyword" data-toggle="tooltip" title="string">var</span> <span id="projectDir">projectDir</span> <span class="punctuation">=</span> <span class="typename" data-toggle="tooltip" title="System.IO.Path">Path</span><span class="punctuation" data-toggle="tooltip" title="System.IO.Path.GetDirectoryName(string)">.</span><span data-toggle="tooltip" title="System.IO.Path.GetDirectoryName(string)">GetDirectoryName</span> <span class="punctuation">(</span><span data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">proj</span><span class="punctuation" data-toggle="tooltip" title="string">.</span><span data-toggle="tooltip" title="string">FilePath</span><span class="punctuation">)</span><span class="punctuation">;</span>
			<span class="keyword">foreach</span> <span class="punctuation">(</span><span class="keyword" data-toggle="tooltip" title="var">var</span> reference <span class="keyword">in</span> <span data-toggle="tooltip" title="?">references</span><span class="punctuation">)</span>
			<span class="punctuation">{</span>
</code></pre>
<p>If there is an attribute name &quot;HintPath&quot; for the metadata, we can
use it to get the assembly file path. If the hint path is relative,
we concatenate it with the solution root path. Otherwise we use it
as-is.</p>
<pre class="csharp"><code class="csharp">				<span class="keyword" data-toggle="tooltip" title="?">var</span> <span id="hintPath">hintPath</span> <span class="punctuation">=</span> <span data-toggle="tooltip" title="var">reference</span><span class="punctuation" data-toggle="tooltip" title="?">.</span><span data-toggle="tooltip" title="?">Metadata</span><span class="punctuation">.</span>FirstOrDefault <span class="punctuation">(</span>pme <span class="punctuation" data-toggle="tooltip" title="lambda expression">=&gt;</span>
					<span data-toggle="tooltip" title="?">pme</span><span class="punctuation" data-toggle="tooltip" title="?">.</span><span data-toggle="tooltip" title="?">Name</span> <span class="punctuation" data-toggle="tooltip" title="bool">==</span> <span class="string" data-toggle="tooltip" title="string">&quot;HintPath&quot;</span><span class="punctuation">)</span><span class="punctuation">;</span>
				<span class="keyword">if</span> <span class="punctuation">(</span><span data-toggle="tooltip" title="?">hintPath</span> <span class="punctuation" data-toggle="tooltip" title="bool">!=</span> <span class="keyword">null</span><span class="punctuation">)</span>
					<span data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.AddMetadataReference(ref Microsoft.CodeAnalysis.Project, string)"><a href="../src/MSBuildHelpers.html#LiterateProgramming.MSBuildHelpers.AddMetadataReference(Microsoft.CodeAnalysis.Project, string)">AddMetadataReference</a></span> <span class="punctuation">(</span><span class="keyword">ref</span> <span data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">proj</span><span class="punctuation">,</span>
						<span class="typename" data-toggle="tooltip" title="System.IO.Path">Path</span><span class="punctuation" data-toggle="tooltip" title="System.IO.Path.IsPathRooted(string)">.</span><span data-toggle="tooltip" title="System.IO.Path.IsPathRooted(string)">IsPathRooted</span> <span class="punctuation">(</span><span data-toggle="tooltip" title="?">hintPath</span><span class="punctuation">.</span>Value<span class="punctuation">)</span> <span class="punctuation" data-toggle="tooltip" title="?">?</span>
							<span data-toggle="tooltip" title="?">hintPath</span><span class="punctuation">.</span>Value <span class="punctuation" data-toggle="tooltip" title="?">:</span>
							<span class="typename" data-toggle="tooltip" title="System.IO.Path">Path</span><span class="punctuation" data-toggle="tooltip" title="System.IO.Path.Combine(string, string)">.</span><span data-toggle="tooltip" title="System.IO.Path.Combine(string, string)">Combine</span> <span class="punctuation">(</span><span data-toggle="tooltip" title="string">projectDir</span><span class="punctuation">,</span> <span data-toggle="tooltip" title="?">hintPath</span><span class="punctuation">.</span>Value<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
</code></pre>
<p>When no hint path is defined, we assume that the assembly
is part of .NET framework and can be found in the reference
assembly directory.</p>
<pre class="csharp"><code class="csharp">				<span class="keyword">else</span>
					<span data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.AddMetadataReference(ref Microsoft.CodeAnalysis.Project, string)"><a href="../src/MSBuildHelpers.html#LiterateProgramming.MSBuildHelpers.AddMetadataReference(Microsoft.CodeAnalysis.Project, string)">AddMetadataReference</a></span> <span class="punctuation">(</span><span class="keyword">ref</span> <span data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">proj</span><span class="punctuation">,</span>
						<span class="typename" data-toggle="tooltip" title="System.IO.Path">Path</span><span class="punctuation" data-toggle="tooltip" title="System.IO.Path.Combine(string, string)">.</span><span data-toggle="tooltip" title="System.IO.Path.Combine(string, string)">Combine</span> <span class="punctuation">(</span><span data-toggle="tooltip" title="string">refAssyDir</span><span class="punctuation">,</span> <span data-toggle="tooltip" title="var">reference</span><span class="punctuation" data-toggle="tooltip" title="?">.</span><span data-toggle="tooltip" title="?">Include</span> <span class="punctuation" data-toggle="tooltip" title="?">+</span> <span class="string" data-toggle="tooltip" title="string">&quot;.dll&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
			<span class="punctuation">}</span>
			<span class="keyword">return</span> <span data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">proj</span><span class="punctuation">;</span>
		<span class="punctuation">}</span>
</code></pre>
<p>Facade assemblies hide under a subdirectory of the reference assembly
path. For good measure, we load all the facades and the mscorlib.dll.</p>
<pre class="csharp"><code class="csharp">		<span class="keyword" id="LiterateProgramming.MSBuildHelpers.AddFacadeReferences(Microsoft.CodeAnalysis.Project, string)" data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.AddFacadeReferences(Microsoft.CodeAnalysis.Project, string)">private</span> <span class="keyword" data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.AddFacadeReferences(Microsoft.CodeAnalysis.Project, string)">static</span> <span class="typename" data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">Project</span> <span data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.AddFacadeReferences(Microsoft.CodeAnalysis.Project, string)">AddFacadeReferences</span> <span class="punctuation">(</span><span class="typename" data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">Project</span> proj<span class="punctuation">,</span> <span class="keyword" data-toggle="tooltip" title="string">string</span> refAssyDir<span class="punctuation">)</span>
		<span class="punctuation">{</span>
			<span class="keyword" data-toggle="tooltip" title="string">var</span> <span id="facadesDir">facadesDir</span> <span class="punctuation">=</span> <span class="typename" data-toggle="tooltip" title="System.IO.Path">Path</span><span class="punctuation" data-toggle="tooltip" title="System.IO.Path.Combine(string, string)">.</span><span data-toggle="tooltip" title="System.IO.Path.Combine(string, string)">Combine</span> <span class="punctuation">(</span><span data-toggle="tooltip" title="string">refAssyDir</span><span class="punctuation">,</span> <span class="string" data-toggle="tooltip" title="string">&quot;Facades&quot;</span><span class="punctuation">)</span><span class="punctuation">;</span>
			<span data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.AddMetadataReference(ref Microsoft.CodeAnalysis.Project, string)"><a href="../src/MSBuildHelpers.html#LiterateProgramming.MSBuildHelpers.AddMetadataReference(Microsoft.CodeAnalysis.Project, string)">AddMetadataReference</a></span> <span class="punctuation">(</span><span class="keyword">ref</span> <span data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">proj</span><span class="punctuation">,</span> <span class="typename" data-toggle="tooltip" title="System.IO.Path">Path</span><span class="punctuation" data-toggle="tooltip" title="System.IO.Path.Combine(string, string)">.</span><span data-toggle="tooltip" title="System.IO.Path.Combine(string, string)">Combine</span> <span class="punctuation">(</span><span data-toggle="tooltip" title="string">refAssyDir</span><span class="punctuation">,</span> <span class="string" data-toggle="tooltip" title="string">&quot;mscorlib.dll&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
			<span class="keyword">foreach</span> <span class="punctuation">(</span><span class="keyword" data-toggle="tooltip" title="string">var</span> dllPath <span class="keyword">in</span> <span class="typename" data-toggle="tooltip" title="CSWeave.Theme.DirHelpers"><a href="../CSWeave.Theme/DirHelpers.html#CSWeave.Theme.DirHelpers">DirHelpers</a></span><span class="punctuation" data-toggle="tooltip" title="CSWeave.Theme.DirHelpers.Dir(string, string, bool)">.</span><span data-toggle="tooltip" title="CSWeave.Theme.DirHelpers.Dir(string, string, bool)"><a href="../CSWeave.Theme/DirHelpers.html#CSWeave.Theme.DirHelpers.Dir(string, string, bool)">Dir</a></span> <span class="punctuation">(</span><span data-toggle="tooltip" title="string">facadesDir</span><span class="punctuation">,</span> <span class="string" data-toggle="tooltip" title="string">&quot;*.dll&quot;</span><span class="punctuation">,</span> <span class="keyword" data-toggle="tooltip" title="bool">false</span><span class="punctuation">)</span><span class="punctuation">)</span>
				<span data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.AddMetadataReference(ref Microsoft.CodeAnalysis.Project, string)"><a href="../src/MSBuildHelpers.html#LiterateProgramming.MSBuildHelpers.AddMetadataReference(Microsoft.CodeAnalysis.Project, string)">AddMetadataReference</a></span> <span class="punctuation">(</span><span class="keyword">ref</span> <span data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">proj</span><span class="punctuation">,</span> <span data-toggle="tooltip" title="string">dllPath</span><span class="punctuation">)</span><span class="punctuation">;</span>
			<span class="keyword">return</span> <span data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">proj</span><span class="punctuation">;</span>
		<span class="punctuation">}</span>
</code></pre>
<p>One common gotcha with Roslyn is that most functions that modify a project
return a new copy of the project instead of mutating it. So we need to
update the variable pointing to project every time we add a new reference.</p>
<p>The function below makes adding a reference bit terser in the code.</p>
<pre class="csharp"><code class="csharp">		<span class="keyword" id="LiterateProgramming.MSBuildHelpers.AddMetadataReference(Microsoft.CodeAnalysis.Project, string)" data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.AddMetadataReference(ref Microsoft.CodeAnalysis.Project, string)">private</span> <span class="keyword" data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.AddMetadataReference(ref Microsoft.CodeAnalysis.Project, string)">static</span> <span class="keyword" data-toggle="tooltip" title="void">void</span> <span data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.AddMetadataReference(ref Microsoft.CodeAnalysis.Project, string)">AddMetadataReference</span> <span class="punctuation">(</span><span class="keyword">ref</span> <span class="typename" data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">Project</span> proj<span class="punctuation">,</span> <span class="keyword" data-toggle="tooltip" title="string">string</span> dllPath<span class="punctuation">)</span>
		<span class="punctuation">{</span>
			<span data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">proj</span> <span class="punctuation" data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">=</span> <span data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">proj</span><span class="punctuation" data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project.AddMetadataReference(Microsoft.CodeAnalysis.MetadataReference)">.</span><span data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project.AddMetadataReference(Microsoft.CodeAnalysis.MetadataReference)">AddMetadataReference</span> <span class="punctuation">(</span><span class="typename" data-toggle="tooltip" title="Microsoft.CodeAnalysis.MetadataReference">MetadataReference</span><span class="punctuation" data-toggle="tooltip" title="Microsoft.CodeAnalysis.MetadataReference.CreateFromFile(string, Microsoft.CodeAnalysis.MetadataReferenceProperties, Microsoft.CodeAnalysis.DocumentationProvider)">.</span><span data-toggle="tooltip" title="Microsoft.CodeAnalysis.MetadataReference.CreateFromFile(string, Microsoft.CodeAnalysis.MetadataReferenceProperties, Microsoft.CodeAnalysis.DocumentationProvider)">CreateFromFile</span> <span class="punctuation">(</span><span data-toggle="tooltip" title="string">dllPath</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span>
		<span class="punctuation">}</span>
</code></pre>
<p>Another helper function finds a projects in a solution file by its name.</p>
<pre class="csharp"><code class="csharp">		<span class="keyword" id="LiterateProgramming.MSBuildHelpers.FindProjectInSolution(Microsoft.CodeAnalysis.Project, Microsoft.Build.Construction.SolutionFile)" data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.FindProjectInSolution(Microsoft.CodeAnalysis.Project, Microsoft.Build.Construction.SolutionFile)">public</span> <span class="keyword" data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.FindProjectInSolution(Microsoft.CodeAnalysis.Project, Microsoft.Build.Construction.SolutionFile)">static</span> <span class="typename" data-toggle="tooltip" title="Microsoft.Build.Construction.ProjectInSolution">ProjectInSolution</span> <span data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.FindProjectInSolution(Microsoft.CodeAnalysis.Project, Microsoft.Build.Construction.SolutionFile)">FindProjectInSolution</span> <span class="punctuation">(</span><span class="typename" data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">Project</span> project<span class="punctuation">,</span> 
			<span class="typename" data-toggle="tooltip" title="Microsoft.Build.Construction.SolutionFile">SolutionFile</span> solutionFile<span class="punctuation">)</span> <span class="punctuation">=&gt;</span>
			<span data-toggle="tooltip" title="Microsoft.Build.Construction.SolutionFile">solutionFile</span><span class="punctuation" data-toggle="tooltip" title="System.Collections.Generic.IReadOnlyList<Microsoft.Build.Construction.ProjectInSolution>">.</span><span data-toggle="tooltip" title="System.Collections.Generic.IReadOnlyList<Microsoft.Build.Construction.ProjectInSolution>">ProjectsInOrder</span><span class="punctuation" data-toggle="tooltip" title="System.Collections.Generic.IEnumerable<Microsoft.Build.Construction.ProjectInSolution>.First<Microsoft.Build.Construction.ProjectInSolution>(System.Func<Microsoft.Build.Construction.ProjectInSolution, bool>)">.</span><span data-toggle="tooltip" title="System.Collections.Generic.IEnumerable<Microsoft.Build.Construction.ProjectInSolution>.First<Microsoft.Build.Construction.ProjectInSolution>(System.Func<Microsoft.Build.Construction.ProjectInSolution, bool>)">First</span> <span class="punctuation">(</span>pis <span class="punctuation" data-toggle="tooltip" title="lambda expression">=&gt;</span> <span data-toggle="tooltip" title="Microsoft.Build.Construction.ProjectInSolution">pis</span><span class="punctuation" data-toggle="tooltip" title="string">.</span><span data-toggle="tooltip" title="string">ProjectName</span> <span class="punctuation" data-toggle="tooltip" title="bool">==</span> <span data-toggle="tooltip" title="Microsoft.CodeAnalysis.Project">project</span><span class="punctuation" data-toggle="tooltip" title="string">.</span><span data-toggle="tooltip" title="string">Name</span><span class="punctuation">)</span><span class="punctuation" data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.FindProjectInSolution(Microsoft.CodeAnalysis.Project, Microsoft.Build.Construction.SolutionFile)">;</span>
</code></pre>
<p>And the last helper function finds a specific property in a project file.</p>
<pre class="csharp"><code class="csharp">		<span class="keyword" id="LiterateProgramming.MSBuildHelpers.ProjectProperty(Microsoft.Build.Construction.ProjectRootElement, string)" data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.ProjectProperty(Microsoft.Build.Construction.ProjectRootElement, string)">public</span> <span class="keyword" data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.ProjectProperty(Microsoft.Build.Construction.ProjectRootElement, string)">static</span> <span class="keyword" data-toggle="tooltip" title="string">string</span> <span data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.ProjectProperty(Microsoft.Build.Construction.ProjectRootElement, string)">ProjectProperty</span> <span class="punctuation">(</span><span class="typename" data-toggle="tooltip" title="Microsoft.Build.Construction.ProjectRootElement">ProjectRootElement</span> root<span class="punctuation">,</span> <span class="keyword" data-toggle="tooltip" title="string">string</span> propertyName<span class="punctuation">)</span> <span class="punctuation">=&gt;</span>
			<span data-toggle="tooltip" title="Microsoft.Build.Construction.ProjectRootElement">root</span><span class="punctuation" data-toggle="tooltip" title="System.Collections.Generic.ICollection<Microsoft.Build.Construction.ProjectPropertyElement>">.</span><span data-toggle="tooltip" title="System.Collections.Generic.ICollection<Microsoft.Build.Construction.ProjectPropertyElement>">Properties</span><span class="punctuation" data-toggle="tooltip" title="System.Collections.Generic.IEnumerable<Microsoft.Build.Construction.ProjectPropertyElement>.First<Microsoft.Build.Construction.ProjectPropertyElement>(System.Func<Microsoft.Build.Construction.ProjectPropertyElement, bool>)">.</span><span data-toggle="tooltip" title="System.Collections.Generic.IEnumerable<Microsoft.Build.Construction.ProjectPropertyElement>.First<Microsoft.Build.Construction.ProjectPropertyElement>(System.Func<Microsoft.Build.Construction.ProjectPropertyElement, bool>)">First</span> <span class="punctuation">(</span>ppe <span class="punctuation" data-toggle="tooltip" title="lambda expression">=&gt;</span> <span data-toggle="tooltip" title="Microsoft.Build.Construction.ProjectPropertyElement">ppe</span><span class="punctuation" data-toggle="tooltip" title="string">.</span><span data-toggle="tooltip" title="string">Name</span> <span class="punctuation" data-toggle="tooltip" title="bool">==</span> <span data-toggle="tooltip" title="string">propertyName</span><span class="punctuation">)</span><span class="punctuation">.</span>Value<span class="punctuation" data-toggle="tooltip" title="LiterateProgramming.MSBuildHelpers.ProjectProperty(Microsoft.Build.Construction.ProjectRootElement, string)">;</span>
	<span class="punctuation">}</span>
<span class="punctuation">}</span>
</code></pre>

				</div>
				<ul class="pager">
	<li class="previous"><a href="../src/TocManager.html">Previous: TOC Manager</a></li>
	<li class="next"><a href="../src/BlockList.html">Next: Source Blocks</a></li>
</ul>
			</div>
        </div>
    </div>
    
    <footer class="panel-footer text-center">
        <div align="center">Copyright © 2017 Tommi Johtela</div>
		<div align="right">
			<small>
				Documentation created with <a href="https://johtela.github.io/LiterateProgramming/">Literate Programming</a>.
			</small>
		</div>
    </footer>


    
    <script src="../bootstrap/js/jquery.min.js"></script>
    <script src="../bootstrap/js/bootstrap.min.js"></script>
    <script src="../sidebar/sidebar.js"></script>
    <script src="../syntax-highlight/syntax.js"></script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
        extensions: ["jsMath2jax.js"]
        });
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML'></script>
	<script src="../mermaid/mermaid.min.js"></script>
	<script>mermaid.initialize({startOnLoad:true});</script>
</body>
</html>